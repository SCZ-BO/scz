<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DR.Xiaomi - Servicio T√©cnico</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2d2d2d;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --accent: #ff7b00;
      --accent-hover: #ff9a3d;
      --border: #374151;
      --success: #16a34a;
      --error: #f97373;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'Roboto',sans-serif;
      background: radial-gradient(circle at top, #1f2933 0, #020617 45%, #000 100%);
      color: var(--text-primary);
      display:flex;
      justify-content:center;
      padding:20px;
      min-height:100vh;
    }

    .container{
      width:100%;
      max-width:430px;
      background:var(--bg-primary);
      border-radius:24px;
      box-shadow:0 20px 40px rgba(0,0,0,0.6),
                 0 0 0 1px rgba(148,163,184,0.15);
      overflow:hidden;
    }

    header{
      background:rgba(15,23,42,0.95);
      padding:14px 16px;
      text-align:center;
      border-bottom:1px solid rgba(148,163,184,0.3);
    }

    header h1{
      color:var(--accent);
      font-size:18px;
      margin:0;
      letter-spacing:0.06em;
    }

    main{
      padding:16px 14px 18px;
      background:var(--bg-primary);
    }

    fieldset{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 10px;
      margin-bottom:14px;
      background:var(--bg-secondary);
    }

    legend{
      padding:0 8px;
      font-weight:600;
      color:var(--text-primary);
      font-size:13px;
    }

    label{
      display:block;
      margin-top:8px;
      color:var(--text-secondary);
      font-size:13px;
    }

    input,select,textarea,button{
      width:100%;
      font-size:14px;
    }

    input,select,textarea{
      padding:8px 10px;
      margin-top:4px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--bg-tertiary);
      color:var(--text-primary);
    }

    input::placeholder,
    textarea::placeholder{
      color:#6b7280;
      font-size:13px;
    }

    button{
      padding:12px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:999px;
      cursor:pointer;
      margin-top:16px;
      font-weight:600;
      letter-spacing:0.03em;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow:0 8px 20px rgba(255,123,0,0.35);
      transition:all 0.25s ease;
    }

    button:hover{
      background:var(--accent-hover);
      transform:translateY(-1px);
      box-shadow:0 12px 26px rgba(255,123,0,0.4);
    }

    .button-icon{
      font-size:16px;
    }

    .date-container{
      margin-bottom:8px;
      text-align:right;
      color:var(--text-secondary);
      font-size:11px;
    }

    #pattern-container{
      position:relative;
      width:100%;
      height:220px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--bg-primary);
      margin-top:8px;
      overflow:hidden;
    }

    #pattern-container canvas{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
    }

    #pattern-sequence{
      margin-top:8px;
      text-align:center;
      color:var(--text-secondary);
      font-size:13px;
    }

    #imagePreview{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .preview-image{
      width:80px;
      height:80px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid var(--border);
    }

    #photoCounter{
      font-size:11px;
      color:var(--text-secondary);
      margin-top:4px;
    }

    #confirmation{
      display:none;
      background:rgba(22,163,74,0.15);
      color:#bbf7d0;
      padding:10px 12px;
      border-radius:999px;
      margin-top:12px;
      text-align:center;
      font-size:12px;
      border:1px solid rgba(34,197,94,0.5);
    }

    .costos-container{
      display:flex;
      gap:12px;
      margin-top:12px;
    }

    .costo-box{
      flex:1;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:var(--bg-tertiary);
    }

    .costo-box label{
      font-weight:600;
      color:var(--text-secondary);
      font-size:12px;
    }

    .costo-box input{
      text-align:right;
      font-weight:600;
      border:none;
      background:transparent;
      color:var(--text-primary);
      margin-top:6px;
      font-size:15px;
    }

    .servicios-container{margin-top:10px;}

    .servicio-item{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }

    .servicio-item input{
      flex:3;
    }

    .servicio-item input[type="number"]{
      flex:1.2;
      text-align:right;
    }

    .servicio-item button{
      flex:0 0 34px;
      margin-top:0;
      padding:6px 0;
      border-radius:999px;
      background:var(--bg-tertiary);
      box-shadow:none;
      color:var(--text-secondary);
    }

    .servicio-item button:hover{
      background:#7f1d1d;
      color:#fecaca;
      box-shadow:0 0 0 1px rgba(248,113,113,0.6);
      transform:none;
    }

    #addServicio{
      background:#2563eb;
      box-shadow:0 8px 18px rgba(37,99,235,0.35);
      width:auto;
      padding-inline:14px;
      font-size:13px;
    }

    #addServicio:hover{
      background:#1d4ed8;
    }

    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      outline:none;
      box-shadow:0 0 0 1px rgba(255,123,0,0.6);
    }

    .required-field::after{
      content:" *";
      color:#f97373;
    }

    #loading{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      z-index:1000;
      justify-content:center;
      align-items:center;
    }

    #loading div{
      background:var(--bg-secondary);
      padding:20px 24px;
      border-radius:16px;
      text-align:center;
      color:var(--text-primary);
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(0,0,0,0.8);
      font-size:13px;
    }

    .spinner{
      border:4px solid #1f2937;
      border-top:4px solid var(--accent);
      border-radius:50%;
      width:30px;
      height:30px;
      animation:spin 1s linear infinite;
      margin:0 auto 10px;
    }

    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    @media(max-width:480px){
      body{padding:10px;}
      .container{border-radius:0;max-width:100%;box-shadow:none;}
      header h1{font-size:16px;}
      label{font-size:12px;}
      .servicio-item{flex-direction:column;align-items:stretch;}
      .servicio-item button{align-self:flex-end;}
      .costos-container{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>RECIBO SERVICIO T√âCNICO</h1></header>
    <main>
      <form id="formRecibo">
        <fieldset>
          <legend>Datos del Cliente</legend>
          <div class="date-container">
            <span id="dateTimeDisplay"></span>
            <span id="numeroReciboDisplay" style="margin-left:10px;"></span>
          </div>
          <label class="required-field">Nombre</label>
          <input type="text" id="nombre" required placeholder="Ej: Juan P√©rez">
          <label class="required-field">Tel√©fono</label>
          <input type="tel" id="telefono" required placeholder="Ej: 75522004" pattern="[0-9]{7,8}">
        </fieldset>

        <fieldset>
          <legend>Dispositivo</legend>
          <label class="required-field">Marca</label>
          <select id="marca" required>
            <option value="">Seleccionar</option>
            <option>Xiaomi</option>
            <option>Samsung</option>
            <option>Huawei</option>
            <option>Tecno</option>
            <option>Honor</option>
            <option>Infinix</option>
            <option>iPhone</option>
          </select>

          <label class="required-field">Modelo</label>
          <input type="text" id="modelo" required placeholder="Ej: Redmi Note 10">

          <label>IMEI/Serial (opcional)</label>
          <input type="text" id="imei" placeholder="15 d√≠gitos">

          <label class="required-field">¬øEnciende?</label>
          <select id="enciende" required>
            <option value="">Seleccionar</option>
            <option>S√≠</option>
            <option>No</option>
            <option>A veces</option>
          </select>
        </fieldset>

        <fieldset>
          <legend>Estado y Falla</legend>
          <label>Estado del equipo</label>
          <textarea id="estado" rows="2" placeholder="Describa el estado f√≠sico del equipo"></textarea>
          <label>Falla reportada</label>
          <textarea id="falla" rows="2" placeholder="Describa la falla que presenta el equipo"></textarea>
        </fieldset>

        <fieldset>
          <legend>Seguridad</legend>
          <label>Tipo</label>
          <select id="tipoSeguridad">
            <option value="patron">Patr√≥n</option>
            <option value="pin">PIN</option>
            <option value="ninguno">Ninguno</option>
          </select>
          <div id="pinContainer" style="display:none;margin-top:8px">
            <label>PIN</label>
            <input type="password" id="pinInput" maxlength="6" placeholder="6 d√≠gitos">
          </div>
        </fieldset>

        <fieldset id="field-patron">
          <legend>Patr√≥n</legend>
          <div id="pattern-container">
            <canvas id="bgCanvas" width="300" height="220"></canvas>
            <canvas id="lineCanvas" width="300" height="220"></canvas>
          </div>
          <div id="pattern-sequence">Secuencia: ‚Äì</div>
        </fieldset>

        <fieldset>
          <legend>Fotos (m√°x.4)</legend>
          <input type="file" id="fotos" accept="image/*" multiple>
          <div id="photoCounter">0/4 fotos seleccionadas</div>
          <div id="imagePreview"></div>
        </fieldset>
        
        <fieldset>
          <legend>Servicios y Costos (Bs.)</legend>
          <div class="servicios-container" id="serviciosList">
            <div class="servicio-item">
              <input type="text" class="servicio-desc" placeholder="Descripci√≥n del servicio">
              <input type="number" class="servicio-costo" placeholder="Bs. 0.00" step="0.01" min="0">
              <button type="button" class="removeServicio" style="display:none">√ó</button>
            </div>
          </div>
          <button type="button" id="addServicio">+ A√±adir otro servicio</button>
          
          <div class="costos-container">
            <div class="costo-box">
              <label>Costo total</label>
              <input type="number" id="costoTotal" placeholder="Bs. 0.00" readonly>
            </div>
          </div>
        </fieldset>
        
        <input type="hidden" id="patternValue">
        <div id="confirmation">Recibo generado con √©xito!</div>
        <button type="submit" id="generateBtn">
          <span class="button-icon">üìÑ</span>
          Generar Recibo PDF
        </button>
      </form>
    </main>
  </div>
  
  <div id="loading">
    <div>
      <div class="spinner"></div>
      <p>Generando recibo...</p>
    </div>
  </div>

  <script>
    // Contador de recibos persistente
    let contadorRecibos = parseInt(localStorage.getItem('contadorRecibos') || '1340', 10);

    const config = {
      nombreTienda: "DR . XIAOMI SCZ",
      direccion: "Centro Comercial Ca√±oto #k1, Santa Cruz",
      telefono: "75522004",
      horario: "Lunes a Viernes 9:00 - 20:00"
    };

    function actualizarHeaderReciboPreview() {
      const fechaSpan = document.getElementById('dateTimeDisplay');
      const numeroSpan = document.getElementById('numeroReciboDisplay');
      if (!fechaSpan || !numeroSpan) return;

      const numeroPreview = `REC-${contadorRecibos + 1}`;
      fechaSpan.textContent = new Date().toLocaleString();
      numeroSpan.textContent = `Recibo #${numeroPreview}`;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      actualizarHeaderReciboPreview();

      // Toggle seguridad
      const tipo = document.getElementById('tipoSeguridad'), 
            pinCont = document.getElementById('pinContainer'), 
            fieldP = document.getElementById('field-patron');

      tipo.addEventListener('change', () => { 
        pinCont.style.display = (tipo.value === 'pin') ? 'block' : 'none'; 
        fieldP.style.display = (tipo.value === 'patron') ? 'block' : 'none'; 
      });
      // Estado inicial (select arranca en "patron")
      pinCont.style.display = 'none';
      fieldP.style.display = 'block';
      
      // Vista previa de im√°genes
      const fotosInput = document.getElementById('fotos');
      const imagePreview = document.getElementById('imagePreview');
      const photoCounter = document.getElementById('photoCounter');
      
      fotosInput.addEventListener('change', function() {
        imagePreview.innerHTML = '';
        const files = this.files;
        if (files.length > 4) {
          photoCounter.textContent = 'M√°ximo 4 fotos. Has seleccionado demasiadas.';
          photoCounter.style.color = '#f97373';
          this.value = '';
          setTimeout(() => {
            photoCounter.textContent = '0/4 fotos seleccionadas';
            photoCounter.style.color = 'var(--text-secondary)';
          }, 2500);
          return;
        }

        photoCounter.textContent = `${files.length}/4 fotos seleccionadas`;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.match('image.*')) continue;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-image');
            imagePreview.appendChild(img);
          }
          reader.readAsDataURL(file);
        }
      });

      // Gesti√≥n de servicios
      const serviciosList = document.getElementById('serviciosList');
      const addServicioBtn = document.getElementById('addServicio');
      const costoTotal = document.getElementById('costoTotal');
      
      function calcularTotal() {
        let total = 0;
        document.querySelectorAll('.servicio-costo').forEach(input => {
          total += parseFloat(input.value) || 0;
        });
        costoTotal.value = total.toFixed(2);
      }
      
      function addServicio() {
        const servicioItem = document.createElement('div');
        servicioItem.className = 'servicio-item';
        servicioItem.innerHTML = `
          <input type="text" class="servicio-desc" placeholder="Descripci√≥n del servicio">
          <input type="number" class="servicio-costo" placeholder="Bs. 0.00" step="0.01" min="0">
          <button type="button" class="removeServicio">√ó</button>
        `;
        serviciosList.appendChild(servicioItem);
        
        servicioItem.querySelector('.removeServicio').addEventListener('click', function() {
          serviciosList.removeChild(servicioItem);
          calcularTotal();
          updateRemoveButtons();
        });
        
        servicioItem.querySelector('.servicio-costo').addEventListener('input', calcularTotal);
        updateRemoveButtons();
      }
      
      function updateRemoveButtons() {
        const items = serviciosList.querySelectorAll('.servicio-item');
        items.forEach((item) => {
          const removeBtn = item.querySelector('.removeServicio');
          removeBtn.style.display = items.length > 1 ? 'block' : 'none';
        });
      }
      
      addServicioBtn.addEventListener('click', () => {
        addServicio();
      });
      
      // Eventos iniciales del primer servicio
      const firstCosto = serviciosList.querySelector('.servicio-costo');
      const firstRemove = serviciosList.querySelector('.removeServicio');

      if (firstCosto) {
        firstCosto.addEventListener('input', calcularTotal);
      }
      if (firstRemove) {
        firstRemove.addEventListener('click', function() {
          if (serviciosList.querySelectorAll('.servicio-item').length > 1) {
            serviciosList.removeChild(this.parentNode);
            calcularTotal();
            updateRemoveButtons();
          }
        });
      }

      updateRemoveButtons();
      
      // Validaci√≥n de tel√©fono (solo n√∫meros)
      document.getElementById('telefono').addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
      
      // PatternLock
      class PatternLock {
        constructor(){
          this.bg = document.getElementById('bgCanvas');
          this.ln = document.getElementById('lineCanvas');
          this.bgc = this.bg.getContext('2d');
          this.lnc = this.ln.getContext('2d');
          this.r = 20; 
          this.w = this.bg.width; 
          this.h = this.bg.height;
          this.pts = []; 
          this.path = []; 
          this.d = false;
          this.seqEl = document.getElementById('pattern-sequence');
          this.valEl = document.getElementById('patternValue');
          this.init();
        }
        init(){
          const cols=3, rows=3, margin=20;
          const sepX=(this.w-2*margin)/(cols-1), sepY=(this.h-2*margin)/(rows-1);
          let id=1;
          for(let y=0;y<rows;y++){
            for(let x=0;x<cols;x++){
              this.pts.push({id:id++,x:margin+sepX*x,y:margin+sepY*y,sel:false});
            }
          }
          this.draw(); 
          this.attach();
        }
        draw(){
          this.bgc.clearRect(0,0,this.w,this.h);
          this.bgc.strokeStyle='#4b5563'; 
          this.bgc.lineWidth=2;
          this.pts.forEach(p=>{
            this.bgc.beginPath();
            this.bgc.arc(p.x,p.y,this.r,0,2*Math.PI);
            this.bgc.stroke();
          });
        }
        attach(){
          ['mousedown','touchstart'].forEach(e=>this.ln.addEventListener(e,ev=>this.start(ev)));
          ['mousemove','touchmove'].forEach(e=>this.ln.addEventListener(e,ev=>this.move(ev)));
          ['mouseup','mouseleave','touchend'].forEach(e=>this.ln.addEventListener(e,()=>this.end()));
        }
        pos(e){
          const rect=this.ln.getBoundingClientRect(),
                t=e.touches?e.touches[0]:e;
          return {x:t.clientX-rect.left,y:t.clientY-rect.top};
        }
        hit(pt){
          return this.pts.find(p=>!p.sel&&Math.hypot(p.x-pt.x,p.y-pt.y)<this.r+5);
        }
        start(e){
          e.preventDefault();
          this.d=true;
          this.path=[];
          this.pts.forEach(p=>p.sel=false);
          this.lnc.clearRect(0,0,this.w,this.h);
          this.seqEl.textContent='Secuencia: ‚Äì';
          this.valEl.value = '';
        }
        move(e){
          if(!this.d)return;
          e.preventDefault();
          const p=this.pos(e),
                h=this.hit(p);
          if(h){
            h.sel=true;
            this.path.push(h);
          }
          this.render(p);
        }
        end(){
          if(!this.d)return;
          this.d=false;
          const seq=this.path.map(p=>p.id);
          this.seqEl.textContent='Secuencia: '+(seq.length ? seq.join(' ‚Üí ') : '‚Äì');
          this.valEl.value=seq.join(',');
        }
        render(c){
          this.lnc.clearRect(0,0,this.w,this.h);
          if(!this.path.length)return;
          this.lnc.strokeStyle='#f97316';
          this.lnc.lineWidth=4;
          this.lnc.lineCap='round';
          this.lnc.beginPath();
          this.lnc.moveTo(this.path[0].x,this.path[0].y);
          this.path.forEach(p=>this.lnc.lineTo(p.x,p.y));
          if(this.d)this.lnc.lineTo(c.x,c.y);
          this.lnc.stroke();
          this.path.forEach(p=>{
            this.lnc.beginPath();
            this.lnc.arc(p.x,p.y,this.r/2,0,2*Math.PI);
            this.lnc.fillStyle='#f97316';
            this.lnc.fill();
          });
        }
      }
      const lock = new PatternLock();
      
      // Generar PDF profesional mejorado
      document.getElementById('formRecibo').addEventListener('submit', async e => {
        e.preventDefault();

        const form = document.getElementById('formRecibo');
        if (!form.checkValidity()) {
          alert('Por favor complete todos los campos requeridos');
          return;
        }

        // Validar que haya al menos un servicio con descripci√≥n o costo > 0
        const servicios = Array.from(document.querySelectorAll('.servicio-item'));
        const hayServicioValido = servicios.some(item => {
          const desc = item.querySelector('.servicio-desc').value.trim();
          const costo = parseFloat(item.querySelector('.servicio-costo').value) || 0;
          return desc !== '' || costo > 0;
        });

        if (!hayServicioValido) {
          alert('Agrega al menos un servicio con descripci√≥n o costo mayor a 0.');
          return;
        }

        const loading = document.getElementById('loading');
        loading.style.display = 'flex';

        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ unit: 'mm', format: 'a4' });

          // ====== DATOS B√ÅSICOS ======
          const fecha = new Date();
          const nombreCompleto = document.getElementById('nombre').value.trim();
          const nombreCliente = nombreCompleto.split(' ')[0] || 'Cliente';
          const telefono = document.getElementById('telefono').value;
          const marca = document.getElementById('marca').value;
          const modelo = document.getElementById('modelo').value;
          const imei = document.getElementById('imei').value;
          const enciende = document.getElementById('enciende').value;
          const estado = document.getElementById('estado').value || '-';
          const falla = document.getElementById('falla').value || '-';
          const tipoSeguridad = document.getElementById('tipoSeguridad').value;
          const pin = document.getElementById('pinInput').value || '-';
          const patron = document.getElementById('patternValue').value || '-';

          // N√∫mero de recibo consistente + guardado
          contadorRecibos++;
          localStorage.setItem('contadorRecibos', contadorRecibos);
          const numeroRecibo = `REC-${contadorRecibos}`;
          actualizarHeaderReciboPreview();

          // ====== FUENTE GENERAL ======
          pdf.setFont('courier', 'normal');
          pdf.setFontSize(9);
          pdf.setTextColor(0);

          let y = 10;
          const marginLeft = 15;
          const centerX = 105;

          // ====== ENCABEZADO TIENDA ======
          pdf.setFontSize(14);
          pdf.setTextColor(255, 152, 0);
          pdf.text(config.nombreTienda, centerX, y + 5, { align: 'center' });

          pdf.setFontSize(8);
          pdf.setTextColor(100);
          pdf.text(config.direccion, centerX, y + 9, { align: 'center' });
          pdf.text(`Tel: ${config.telefono} ¬∑ ${config.horario}`, centerX, y + 13, { align: 'center' });

          pdf.setDrawColor(255, 152, 0);
          pdf.line(20, y + 16, 190, y + 16);

          // ====== T√çTULO ======
          y += 24;
          pdf.setFontSize(11);
          pdf.setTextColor(0);
          pdf.setFont('courier', 'bold');
          pdf.text('RECIBO DE SERVICIO T√âCNICO', centerX, y, { align: 'center' });

          // N√∫mero y fecha
          y += 6;
          pdf.setFontSize(8);
          pdf.setFont('courier', 'normal');
          pdf.text(`N¬∞ Recibo: ${numeroRecibo}`, marginLeft, y);
          pdf.text(
            `Fecha: ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString().slice(0, 5)}`,
            200 - marginLeft,
            y,
            { align: 'right' }
          );

          // ====== DATOS DEL CLIENTE ======
          y += 8;
          pdf.setFont('courier', 'bold');
          pdf.text('DATOS DEL CLIENTE', marginLeft, y);
          pdf.setDrawColor(200);
          pdf.line(marginLeft, y + 1, 195, y + 1);

          y += 5;
          pdf.setFont('courier', 'normal');
          pdf.setFontSize(9);
          pdf.text(`Nombre: ${nombreCompleto}`, marginLeft, y);
          y += 5;
          pdf.text(`Tel√©fono: ${telefono}`, marginLeft, y);

          // ====== DATOS DEL EQUIPO ======
          y += 8;
          pdf.setFont('courier', 'bold');
          pdf.text('DATOS DEL EQUIPO', marginLeft, y);
          pdf.setDrawColor(200);
          pdf.line(marginLeft, y + 1, 195, y + 1);

          pdf.setFont('courier', 'normal');
          y += 5;
          pdf.text(`Marca: ${marca}`, marginLeft, y);
          y += 5;
          pdf.text(`Modelo: ${modelo}`, marginLeft, y);
          y += 5;
          pdf.text(`¬øEnciende?: ${enciende}`, marginLeft, y);
          if (imei) {
            y += 5;
            pdf.text(`IMEI/Serial: ${imei}`, marginLeft, y);
          }

          // ====== ESTADO Y FALLA ======
          y += 8;
          pdf.setFont('courier', 'bold');
          pdf.text('ESTADO Y FALLA', marginLeft, y);
          pdf.setDrawColor(200);
          pdf.line(marginLeft, y + 1, 195, y + 1);

          pdf.setFont('courier', 'normal');
          y += 5;
          pdf.text(`Estado: ${estado}`, marginLeft, y);
          y += 5;
          pdf.text(`Falla reportada: ${falla}`, marginLeft, y);

          // ====== SERVICIOS ======
          y += 8;
          pdf.setFont('courier', 'bold');
          pdf.text('SERVICIOS Y COSTOS (Bs.)', marginLeft, y);
          pdf.setDrawColor(200);
          pdf.line(marginLeft, y + 1, 195, y + 1);

          const serviciosData = [];
          document.querySelectorAll('.servicio-item').forEach(item => {
            const desc = item.querySelector('.servicio-desc').value || '-';
            const costo = parseFloat(item.querySelector('.servicio-costo').value) || 0;
            serviciosData.push([desc, `Bs. ${costo.toFixed(2)}`]);
          });

          pdf.autoTable({
            startY: y + 4,
            head: [['Descripci√≥n', 'Costo (Bs.)']],
            body: serviciosData,
            styles: { fontSize: 8, font: 'courier' },
            headStyles: { fillColor: [50, 50, 50], textColor: 255 },
            columnStyles: {
              0: { cellWidth: 120 },
              1: { halign: 'right' }
            },
            margin: { left: marginLeft, right: 15 }
          });

          y = pdf.autoTable.previous.finalY + 4;

          const total = parseFloat(document.getElementById('costoTotal').value) || 0;
          pdf.setFont('courier', 'bold');
          pdf.setFontSize(10);
          pdf.setDrawColor(255, 152, 0);
          pdf.setFillColor(255, 250, 240);

          pdf.roundedRect(120, y - 4, 70, 8, 2, 2, 'FD');
          pdf.text(`TOTAL: Bs. ${total.toFixed(2)}`, 155, y + 1, { align: 'center' });

          // ====== SEGURIDAD ======
          y += 12;
          pdf.setFont('courier', 'bold');
          pdf.setFontSize(9);
          pdf.text('SEGURIDAD DEL DISPOSITIVO', marginLeft, y);
          pdf.setDrawColor(200);
          pdf.line(marginLeft, y + 1, 195, y + 1);

          pdf.setFont('courier', 'normal');
          y += 5;
          pdf.text(`Tipo de seguridad: ${tipoSeguridad}`, marginLeft, y);

          if (tipoSeguridad === 'pin') {
            y += 5;
            pdf.text(`PIN: ${pin}`, marginLeft, y);
          } else if (tipoSeguridad === 'patron') {
            y += 5;
            pdf.text(`Secuencia patr√≥n: ${patron}`, marginLeft, y);
          }

          // ====== IM√ÅGENES ======
          const files = document.getElementById('fotos').files;
          if (files.length > 0) {
            y += 10;
            pdf.setFont('courier', 'bold');
            pdf.text('IM√ÅGENES DEL EQUIPO', marginLeft, y);
            pdf.setDrawColor(200);
            pdf.line(marginLeft, y + 1, 195, y + 1);

            let xImg = marginLeft;
            let yImg = y + 4;

            for (let i = 0; i < Math.min(files.length, 4); i++) {
              const file = files[i];
              const imageData = await new Promise(res => {
                const r = new FileReader();
                r.onload = e2 => res(e2.target.result);
                r.readAsDataURL(file);
              });

              if (yImg > 230) {
                pdf.addPage();
                yImg = 20;
                xImg = marginLeft;
              }

              pdf.addImage(imageData, 'JPEG', xImg, yImg, 80, 40);

              if (i % 2 === 0) {
                xImg += 90;
              } else {
                xImg = marginLeft;
                yImg += 45;
              }
            }

            y = yImg + 50;
          } else {
            y += 8;
          }

          // ====== CONDICIONES ======
          if (y > 230) {
            pdf.addPage();
            y = 20;
          }

          pdf.setFont('courier', 'bold');
          pdf.setFontSize(9);
          pdf.text('CONDICIONES DEL SERVICIO', marginLeft, y);
          pdf.setDrawColor(200);
          pdf.line(marginLeft, y + 1, 195, y + 1);

          pdf.setFont('courier', 'normal');
          pdf.setFontSize(7);
          y += 5;

          const condiciones = [
            '1. Conserve este recibo; solo con √©l puede retirar su equipo.',
            '2. La fecha de entrega est√° sujeta a disponibilidad de repuestos.',
            '3. El retiro debe hacerse dentro de los 10 d√≠as posteriores al aviso.',
            '4. Pasados 30 d√≠as sin retiro, el equipo se considera abandonado.',
            '5. Garant√≠a: 30 d√≠as en repuesto / 60 d√≠as en mano de obra.'
          ];

          condiciones.forEach((txt, i) => {
            pdf.text(txt, marginLeft, y + i * 4);
          });

          const firmaY = y + condiciones.length * 4 + 10;
          pdf.line(130, firmaY, 190, firmaY);
          pdf.text('Firma del cliente', 160, firmaY + 4, { align: 'center' });

          pdf.setFontSize(7);
          pdf.setTextColor(120);
          pdf.text(
            `¬© ${fecha.getFullYear()} ${config.nombreTienda} ¬∑ Todos los derechos reservados`,
            centerX,
            287,
            { align: 'center' }
          );

          pdf.save(`Recibo_${numeroRecibo}_${nombreCliente}.pdf`);

          const confirmation = document.getElementById('confirmation');
          confirmation.textContent = `Recibo ${numeroRecibo} generado con √©xito!`;
          confirmation.style.display = 'block';
          setTimeout(() => (confirmation.style.display = 'none'), 4000);

        } catch (err) {
          alert('Error al generar PDF: ' + err.message);
        } finally {
          loading.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
